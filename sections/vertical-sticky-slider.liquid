<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

{%- style -%}
  .left-side{
    padding: 50px;

  }
  .vertical-slider-{{ section.id }} {
    margin-top: {{ section.settings.margin_top }}px;
    margin-bottom: {{ section.settings.margin_bottom }}px;
    background-color: {{ section.settings.bg_color }};
  }

  .vertical-slider-{{ section.id }} h2 { font-size: 30px; text-transform: uppercase; margin: 0; color: {{ section.settings.text_color }}; }
  .vertical-slider-{{ section.id }} h3 { font-size: 40px; text-transform: uppercase; margin: 0; color: {{ section.settings.text_color }}; }

  .mobile-only { display: block; }
  .desktop-only { display: none !important; }

  @media (max-width: 1023px) {
    .image-wrapper-mob { height: 100vw; overflow: hidden; }
    .image-wrapper-mob img { width: 100%; height: 100%; object-fit: cover; }
    .content-mob { text-align: center; padding: 3rem 1.5rem; }
  }

  @media (min-width: 1024px) {
    .vertical-slider-{{ section.id }} h2 { font-size: 4vw; }
    .vertical-slider-{{ section.id }} h3 { font-size: 5vw; }
    .mobile-only { display: none !important; }
    .desktop-only { display: flex !important; }

    .left-side { width: 50%; position: relative; }
    .right-side { width: 50%; }

    .sticky-container { position: sticky; top: 0; height: 100vh; width: 100%; overflow: hidden; }

    .image-wrapper {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      clip-path: inset(100% 0% 0% 0%); /* Hidden state */
      z-index: 1;
    }

    .image-wrapper.first-slide { clip-path: inset(0% 0% 0% 0%); z-index: 0; }

    .image-wrapper img { width: 100%; height: 100%; object-fit: cover; }

    .content-wrapper {
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 10%;
    }
  }
{%- endstyle -%}

<div class="vertical-slider-{{ section.id }}">
  <div class="mobile-only">
    {% for block in section.blocks %}
      <div class="slide-mob">
        <div class="image-wrapper-mob">
          {% if block.settings.image != blank %}
            {{ block.settings.image | image_url: width: 1000 | image_tag }}
          {% else %}
            {{ 'image' | placeholder_svg_tag }}
          {% endif %}
        </div>
        <div class="content-mob">
          <h2>{{ block.settings.heading }}</h2>
          <h3>{{ block.settings.subheading }}</h3>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="desktop-only">
    <div class="left-side">
      <div class="sticky-container">
        {% for block in section.blocks %}
          <div class="image-wrapper {% if forloop.first %}first-slide{% endif %}" data-index="{{ forloop.index0 }}">
            {% if block.settings.image != blank %}
              {{ block.settings.image | image_url: width: 1800 | image_tag }}
            {% else %}
              {{ 'lifestyle-1' | placeholder_svg_tag }}
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="right-side">
      {% for block in section.blocks %}
        <div class="content-wrapper" data-index="{{ forloop.index0 }}">
          <div class="content-desktop">
            <h2>{{ block.settings.heading }}</h2>
            <h3>{{ block.settings.subheading }}</h3>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  // Wait for GSAP and ScrollTrigger to be available
  function initGsapSlider() {
    if (typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
      gsap.registerPlugin(ScrollTrigger);

      const images = document.querySelectorAll('.vertical-slider-{{ section.id }} .image-wrapper');
      const contents = document.querySelectorAll('.vertical-slider-{{ section.id }} .content-wrapper');

      images.forEach((img, i) => {
        if (i === 0) return; // Skip the first image (already visible)

        gsap.to(img, {
          clipPath: 'inset(0% 0% 0% 0%)',
          ease: 'none',
          scrollTrigger: {
            trigger: contents[i],
            start: 'top bottom',
            end: 'top top',
            scrub: true,
          },
        });
      });
    } else {
      // If not loaded yet, check again in 100ms
      setTimeout(initGsapSlider, 100);
    }
  }

  // Start the check
  initGsapSlider();

  // Re-init for Shopify Theme Editor
  document.addEventListener('shopify:section:load', initGsapSlider);
</script>

{% schema %}
{
  "name": "GSAP Sticky Slider",
  "settings": [
    { "type": "color", "id": "bg_color", "label": "Background Color", "default": "#ffffff" },
    { "type": "color", "id": "text_color", "label": "Text Color", "default": "#000000" },
    {
      "type": "range",
      "id": "margin_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Margin Top",
      "default": 0
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Margin Bottom",
      "default": 0
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "heading", "label": "Heading", "default": "Here are some" },
        { "type": "text", "id": "subheading", "label": "Sub-Heading", "default": "Perks for joining" }
      ]
    }
  ],
  "presets": [{ "name": "GSAP Sticky Slider" }]
}
{% endschema %}
